<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Recipes - Gammaw's Recipe Cards</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>My Recipe Cards</h1>
        <button id="addRecipeBtn" class="btn">Add New Recipe</button>
        <button id="logoutBtn" class="btn">Logout</button>
      </header>

      <div class="recipe-grid" id="recipeGrid">
        <!-- Recipes will be dynamically added here -->
      </div>

      <!-- Add/Edit Recipe Modal -->
      <div id="recipeModal" class="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h2 id="modalTitle">Add New Recipe</h2>
          <form id="recipeForm">
            <input type="hidden" id="recipeId" />
            <div class="form-group">
              <label for="title">Recipe Title</label>
              <input type="text" id="title" name="title" required />
            </div>
            <div class="form-group">
              <label for="image">Recipe Image</label>
              <input type="file" id="image" name="image" accept="image/*" />
              <div id="imagePreview"></div>
            </div>
            <div class="form-group">
              <label for="ingredients">Ingredients (one per line)</label>
              <textarea id="ingredients" name="ingredients" required></textarea>
            </div>
            <div class="form-group">
              <label for="instructions">Instructions</label>
              <textarea
                id="instructions"
                name="instructions"
                required
              ></textarea>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="cookingTime">Cooking Time (minutes)</label>
                <input
                  type="number"
                  id="cookingTime"
                  name="cookingTime"
                  required
                />
              </div>
              <div class="form-group">
                <label for="servings">Servings</label>
                <input type="number" id="servings" name="servings" required />
              </div>
            </div>
            <button type="submit" class="btn">Save Recipe</button>
          </form>
        </div>
      </div>

      <!-- View Recipe Modal -->
      <div id="viewRecipeModal" class="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <div id="recipeDetails"></div>
        </div>
      </div>
    </div>

    <script type="module">
      import { isAuthenticated, logout } from './js/auth.js'
      import {
        getRecipes,
        createRecipe,
        updateRecipe,
        viewRecipe,
        editRecipe,
        deleteRecipeHandler,
      } from './js/recipes.js'

      // Make functions available globally for onclick handlers
      window.viewRecipe = viewRecipe
      window.editRecipe = editRecipe
      window.deleteRecipeHandler = deleteRecipeHandler
      window.loadRecipes = loadRecipes

      // Check authentication before doing anything else
      if (!isAuthenticated()) {
        window.location.href = '/index.html'
      }

      // DOM Elements
      const recipeGrid = document.getElementById('recipeGrid')
      const recipeModal = document.getElementById('recipeModal')
      const viewRecipeModal = document.getElementById('viewRecipeModal')
      const recipeForm = document.getElementById('recipeForm')
      const addRecipeBtn = document.getElementById('addRecipeBtn')
      const logoutBtn = document.getElementById('logoutBtn')
      const imageInput = document.getElementById('image')
      const imagePreview = document.getElementById('imagePreview')

      // Load recipes function
      async function loadRecipes() {
        try {
          const recipes = await getRecipes()
          recipeGrid.innerHTML = recipes
            .map(
              (recipe) => `
            <div class="recipe-card" data-id="${recipe._id}">
              <div class="recipe-image">
                <img src="${
                  recipe.image || 'images/default-recipe.jpg'
                }" alt="${recipe.title}">
              </div>
              <div class="recipe-info">
                <h3>${recipe.title}</h3>
                <p>Cooking Time: ${recipe.cookingTime} mins</p>
                <p>Servings: ${recipe.servings}</p>
                <div class="recipe-actions">
                  <button onclick="viewRecipe('${
                    recipe._id
                  }')" class="btn">View</button>
                  <button onclick="editRecipe('${
                    recipe._id
                  }')" class="btn">Edit</button>
                  <button onclick="deleteRecipeHandler('${
                    recipe._id
                  }')" class="btn delete">Delete</button>
                </div>
              </div>
            </div>
          `
            )
            .join('')
        } catch (error) {
          console.error('Error loading recipes:', error)
          alert('Error loading recipes: ' + error.message)
        }
      }

      // Event Listeners
      addRecipeBtn.addEventListener('click', () => {
        recipeForm.reset()
        document.getElementById('modalTitle').textContent = 'Add New Recipe'
        document.getElementById('recipeId').value = ''
        imagePreview.innerHTML = ''
        recipeModal.style.display = 'block'
      })

      logoutBtn.addEventListener('click', () => {
        logout()
        window.location.href = '/index.html'
      })

      // Close modals
      document.querySelectorAll('.close').forEach((closeBtn) => {
        closeBtn.addEventListener('click', () => {
          recipeModal.style.display = 'none'
          viewRecipeModal.style.display = 'none'
        })
      })

      // Handle image preview
      imageInput.addEventListener('change', (e) => {
        const file = e.target.files[0]
        if (file) {
          const reader = new FileReader()
          reader.onload = (e) => {
            imagePreview.innerHTML = `<img src="${e.target.result}" alt="Preview">`
          }
          reader.readAsDataURL(file)
        }
      })

      // Handle form submission
      recipeForm.addEventListener('submit', async (e) => {
        e.preventDefault()
        const recipeId = document.getElementById('recipeId').value
        const formData = new FormData()
        formData.append('title', document.getElementById('title').value)
        formData.append(
          'instructions',
          document.getElementById('instructions').value
        )
        formData.append(
          'cookingTime',
          document.getElementById('cookingTime').value
        )
        formData.append('servings', document.getElementById('servings').value)

        // Handle ingredients
        const ingredients = document
          .getElementById('ingredients')
          .value.split('\n')
          .filter((ingredient) => ingredient.trim())
        ingredients.forEach((ingredient, index) => {
          formData.append(`ingredients[${index}]`, ingredient.trim())
        })

        // Handle image
        const imageFile = document.getElementById('image').files[0]
        if (imageFile) {
          formData.append('image', imageFile)
        }

        try {
          if (recipeId) {
            await updateRecipe(recipeId, formData)
          } else {
            await createRecipe(formData)
          }
          recipeModal.style.display = 'none'
          loadRecipes()
        } catch (error) {
          alert(error.message)
        }
      })

      // Load recipes when page loads
      loadRecipes()
    </script>
  </body>
</html>
